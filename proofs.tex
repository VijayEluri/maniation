\chapter{Proofs and derivations\label{proofs}}
\section{Quaternion integration\label{quatProofs}}
\subsection{Instantaneous rate of change\label{quatRateOfChangeOrthogonal}}
The instantaneous rate of change is given to be
\begin{eqnarray*}
\dot{\mathbf{q}} & = & \frac{1}{2}\bm{\omega}\mathbf{q} =
    \frac{1}{2}(\omega_1\mathbf{i} + \omega_2\mathbf{j} + \omega_3\mathbf{k})
    (q_w + q_x\mathbf{i} + q_y\mathbf{j} + q_z\mathbf{k}) \\
& = & \frac{1}{2} ( - \omega_1 q_x - \omega_2 q_y - \omega_3 q_z ) +
    \frac{\mathbf{i}}{2} ( \omega_1 q_w + \omega_2 q_z - \omega_3 q_y ) + \\
&&  \frac{\mathbf{j}}{2} (-\omega_1 q_z + \omega_2 q_w + \omega_3 q_x ) +
    \frac{\mathbf{k}}{2} ( \omega_1 q_y - \omega_2 q_x + \omega_3 q_w )
\end{eqnarray*}

We now treat $\mathbf{q}$ and $\dot{\mathbf{q}}$ as 4D vectors and calculate
their dot product:
\begin{eqnarray*}
\mathbf{q}\cdot\dot{\mathbf{q}} & = & \frac{1}{2} (
    - q_w \omega_1 q_x - q_w \omega_2 q_y - q_w \omega_3 q_z
    + q_x \omega_1 q_w + q_x \omega_2 q_z - q_x \omega_3 q_y \\
&&  - q_y \omega_1 q_z + q_y \omega_2 q_w + q_y \omega_3 q_x
    + q_z \omega_1 q_y - q_z \omega_2 q_x + q_z \omega_3 q_w ) \\
& = & 0.
\end{eqnarray*}
The rate of change is orthogonal to $\mathbf{q}$, and therefore it is always
a tangent to the sphere, touching it at the point corresponding to $\mathbf{q}$.

We can determine the magnitude $||\dot{\mathbf{q}}||$ from the sum of squares of the
components given above and find it to be
$||\dot{\mathbf{q}}|| = \frac{1}{2}||\bm{\omega}||\,||\mathbf{q}||$. Since we always
require $\mathbf{q}$ to be a unit quaternion, we can reduce this to
\begin{equation}
\label{quatRateOfChangeMagnitude}
||\dot{\mathbf{q}}|| = \frac{1}{2}||\bm{\omega}||.
\end{equation}

\subsection{Corrected quaternion integration\label{quatIntegrationDerivation}}

Assume that the body we are simulating is rotating at a constant angular velocity.
(This assumption is later weakened by the use of a more sophisticated ODE solver,
but for now we will stick with Euler's method.) Furthermore assume without loss of
generality that the body is rotating clockwise about its $x$ axis, which corresponds
to the world's $x$ axis. Then the orientation of the body (the quaternion describing
the linear transformation to get from the body's frame of reference into the world
frame) is given as a function of time by
\begin{equation}
\label{quatDerivationExact}
\mathbf{q}(t) = \cos\left(\frac{||\bm{\omega}||t}{2}\right) +
    \sin\left(\frac{||\bm{\omega}||t}{2}\right)\mathbf{i}
\end{equation}
(cf. equation~\ref{quatRotation}) and its angular velocity is
\begin{equation}
\bm{\omega} = (\omega_1, \omega_2, \omega_3) = (||\bm{\omega}||, 0, 0)
\end{equation}
for some arbitrary $||\bm{\omega}||$, measured in radians per unit time.

Now assume w.l.o.g. that we take a time step from $t = 0$ to $t = \Delta t$.
Then we require that the result returned by Euler's method for $\mathbf{q}(\Delta t)$
after re-normalization be equal to its exact value in equation~\ref{quatDerivationExact}:
\begin{equation}
\label{quatDerivationSetup}
\cos\left(\frac{||\bm{\omega}||\Delta t}{2}\right) +
    \sin\left(\frac{||\bm{\omega}||\Delta t}{2}\right)\mathbf{i} =
    \frac{\mathbf{q}(0) + \Delta t \dot{\mathbf{q}}(0)}
        {||\mathbf{q}(0) + \Delta t \dot{\mathbf{q}}(0)||}
\end{equation}

We know from examining the 4D geometry that the value assigned to $\dot{\mathbf{q}}$
in equation~\ref{quatRateOfChange} has the correct direction and merely needs to be
corrected in magnitude. In other words, we are searching for a scalar function
$f(\Delta t, ||\bm{\omega}||)$ which will allow $\dot{\mathbf{q}}$ to satisfy
equation~\ref{quatDerivationSetup}:
\begin{equation}
\dot{\mathbf{q}}_{\Delta t}(t) = f\tilde{\bm{\omega}}(t)\mathbf{q}(t)
\end{equation}

Observe that under the above assumptions $\mathbf{q}(0) = 1$, and thus
$\dot{\mathbf{q}}_{\Delta t}(0) = f ||\bm{\omega}|| \mathbf{i}$. Substituting this
into equation~\ref{quatDerivationSetup} and considering only the real part:
\begin{eqnarray*}
&& \cos\left(\frac{||\bm{\omega}||\Delta t}{2}\right) =
    \left[1 + \left( f ||\bm{\omega}||\Delta t \right)^2 \right]^{-\frac{1}{2}} \\
&\Leftrightarrow&
    \left( f ||\bm{\omega}||\Delta t \right)^2 =
    \frac{1}{\cos^2\left(\frac{||\bm{\omega}||\Delta t}{2}\right)} - 1 \\
&\Leftrightarrow&
    f(\Delta t, ||\bm{\omega}||) =
    \frac{1}{||\bm{\omega}||\Delta t} \sqrt{\frac{
        1 - \cos^2\left(\frac{||\bm{\omega}||\Delta t}{2}\right)}{
        \cos^2\left(\frac{||\bm{\omega}||\Delta t}{2}\right)}} =
    \frac{1}{||\bm{\omega}||\Delta t}
        \tan\left(\frac{||\bm{\omega}||\Delta t}{2}\right)
\end{eqnarray*}

To check, we substitute this result into the $\mathbf{i}$-imaginary part of
equation~\ref{quatDerivationSetup}:
\begin{eqnarray*}
\sin\left(\frac{||\bm{\omega}||\Delta t}{2}\right) & = &
    \tan\left(\frac{||\bm{\omega}||\Delta t}{2}\right)
    \left[ 1 + \tan^2\left(\frac{||\bm{\omega}||\Delta t}{2}\right)
    \right]^{-\frac{1}{2}} \\
&=& \tan\left(\frac{||\bm{\omega}||\Delta t}{2}\right)
    \left[ \frac{\cos^2\left(\frac{||\bm{\omega}||\Delta t}{2}\right) +
    \sin^2\left(\frac{||\bm{\omega}||\Delta t}{2}\right) }{
    \cos^2\left(\frac{||\bm{\omega}||\Delta t}{2}\right) }
    \right]^{-\frac{1}{2}} \\
&=& \tan\left(\frac{||\bm{\omega}||\Delta t}{2}\right)
    \cos\left(\frac{||\bm{\omega}||\Delta t}{2}\right) \\
&=& \sin\left(\frac{||\bm{\omega}||\Delta t}{2}\right)
\end{eqnarray*}

Thus we establish the validity of this expression for $f$. Observe that by using 
L'Hospital's rule, we can find value of $f$ for an infinitessimally small time step:
$$
\lim_{\Delta t \to 0} f = \lim_{\Delta t \to 0} \frac{ \frac{||\bm{\omega}||}{2}
    \cos^{-2}\left(\frac{||\bm{\omega}||\Delta t}{2}\right) }{ ||\bm{\omega}|| } =
    \frac{1}{2}
$$
i.e. we obtain the original equation~\ref{quatRateOfChange} for the
instantaneous rate of change.

Now let $\Delta \mathbf{q} = \Delta t \dot{\mathbf{q}} =
    \frac{\Delta t}{2} \tilde{\bm{\omega}} \mathbf{q}$.
From equation~\ref{quatRateOfChangeMagnitude} we find that
$||\Delta\mathbf{q}|| = \frac{||\bm{\omega}||\Delta t}{2}$.
Hence we can simplify the expression for the quaternion correcting factor by expressing it
in terms of $\Delta \mathbf{q}$ as follows:
$$
\Delta t f \tilde{\bm{\omega}}\mathbf{q} = \frac{\Delta t}{||\bm{\omega}||\Delta t}
    \tan\left(\frac{||\bm{\omega}||\Delta t}{2}\right) \tilde{\bm{\omega}} \mathbf{q} =
    \tan\left(||\Delta\mathbf{q}||\right) \frac{\Delta\mathbf{q}}{||\Delta\mathbf{q}||}
$$

This expression now has a clear geometric interpretation with respect to the 4D geometry:
$||\Delta\mathbf{q}||$ is measured in radians, and it corresponds to the {\em correct}
angle between the old and the new vector $\mathbf{q}$. Since $\mathbf{q}$ and
$\dot{\mathbf{q}}$ are orthogonal, we have a right-angled triangle between the origin,
the old and the new points $\mathbf{q}$, and hence we can use the $\tan$ function to
evaluate the required length of the side in direction $\Delta\mathbf{q}$.

Finally we can combine this correction and the subsequent quaternion normalisation into
a single function:
\begin{eqnarray*}
\mathbf{q}(t+\Delta t) = \mathrm{Quergs}(\mathbf{q}(t), \Delta\mathbf{q}) &=&
    \frac{\mathbf{q}(t) + \tan\left(||\Delta\mathbf{q}||\right)
        \frac{\Delta\mathbf{q}}{||\Delta\mathbf{q}||}}{
    ||\mathbf{q}(t) + \tan\left(||\Delta\mathbf{q}||\right)
        \frac{\Delta\mathbf{q}}{||\Delta\mathbf{q}||}||} \\
&=& \frac{\mathbf{q}(t) + \tan\left(||\Delta\mathbf{q}||\right)
        \frac{\Delta\mathbf{q}}{||\Delta\mathbf{q}||}}{
    \sqrt{1 + \tan^2\left(||\Delta\mathbf{q}||\right)}} \\
&=& \frac{\mathbf{q}(t) + \tan\left(||\Delta\mathbf{q}||\right)
        \frac{\Delta\mathbf{q}}{||\Delta\mathbf{q}||}}{
    \cos\left(||\Delta\mathbf{q}||\right)}
\end{eqnarray*}
The last expression is simplest (and again allows geometric interpretation), but probably
the penultimate expression is more useful for numerical evaluation, since it involves only
one trigonometric function.
